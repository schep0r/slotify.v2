#!/usr/bin/env php
<?php

/**
 * Coverage checker script
 * 
 * This script checks if the code coverage meets the minimum threshold.
 * It reads the coverage.xml file generated by PHPUnit and compares the coverage percentage
 * against the defined minimum threshold.
 */

if (!file_exists('coverage.xml')) {
    echo "âŒ Coverage file 'coverage.xml' not found. Run tests with coverage first.\n";
    echo "   Example: XDEBUG_MODE=coverage php bin/phpunit --coverage-clover=coverage.xml\n";
    exit(1);
}

$xml = simplexml_load_file('coverage.xml');
if (!$xml) {
    echo "âŒ Failed to parse coverage.xml file.\n";
    exit(1);
}

$metrics = $xml->project->metrics;
$lines = (int)$metrics['elements'];
$coveredLines = (int)$metrics['coveredelements'];

if ($lines === 0) {
    echo "âš ï¸  No measurable code found.\n";
    exit(0);
}

$percentage = ($coveredLines / $lines) * 100;

// Minimum coverage threshold - adjust this value as your coverage improves
$minCoverage = 6.0;

echo sprintf("ğŸ“Š Code Coverage Report:\n");
echo sprintf("   Lines covered: %d/%d\n", $coveredLines, $lines);
echo sprintf("   Coverage: %.2f%%\n", $percentage);
echo sprintf("   Threshold: %.1f%%\n", $minCoverage);
echo "\n";

if ($percentage < $minCoverage) {
    echo sprintf("âŒ Coverage %.2f%% is below minimum threshold of %.1f%%\n", $percentage, $minCoverage);
    echo "   Please add more tests to improve coverage.\n";
    exit(1);
}

echo sprintf("âœ… Coverage %.2f%% meets minimum threshold of %.1f%%\n", $percentage, $minCoverage);

// Provide encouragement for good coverage
if ($percentage >= 80) {
    echo "ğŸ‰ Excellent coverage!\n";
} elseif ($percentage >= 60) {
    echo "ğŸ‘ Good coverage!\n";
} elseif ($percentage >= 40) {
    echo "ğŸ“ˆ Decent coverage, keep improving!\n";
} else {
    echo "ğŸ“ Consider adding more tests to improve coverage.\n";
}

exit(0);